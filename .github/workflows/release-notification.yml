name: Release notification

on:
  push:
    tags:
      - dialtone/v*

env:
  RELEASE_URL: ${{ format('https://github.com/dialpad/dialtone/releases/tag/{0}', github.ref_name) }}

jobs:
  send-sms:
    name: Send SMS
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      API_URL: https://us-central1-dp-dialtone-design-system.cloudfunctions.net/send-sms-to-dialtone-test-channel
    steps:
      - id: get-released-version
        name: Get released version from tag
        run: |
          echo "RELEASE_VERSION=${GITHUB_REF#*dialtone/v}" >> $GITHUB_ENV

      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.DIALTONE_GCP_WIP }}
          service_account: ${{ secrets.DIALTONE_GCP_SA }}
          token_format: "id_token"
          id_token_audience: ${{ env.API_URL }}

      - name: Send sms
        run: |
          curl -m 70 -X POST ${{ env.API_URL }} \
          -H "Authorization: bearer ${{ steps.auth.outputs.id_token }}" \
          -H "Content-Type: application/json" \
          -d '{
            "message": "A new dialtone version has been published: \"${{ env.RELEASE_VERSION }}\". Read the full changelog: ${{ env.RELEASE_URL }}"
          }'
