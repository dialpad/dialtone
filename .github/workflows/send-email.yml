name: Send communications
on:
  workflow_dispatch:
    inputs:
      post_file_name:
        description: 'The post file name'
        required: true
  pull_request:
    paths:
      - 'apps/dialtone-documentation/docs/about/whats-new/posts/*.md'
  push:
    branches:
      - production
    paths:
      - 'apps/dialtone-documentation/docs/about/whats-new/posts/*.md'

env:
  HUSKY: 0

jobs:
  get-branch-name:
    runs-on: ubuntu-latest
    outputs:
      current_branch: ${{ steps.branch-name.outputs.current_branch }}
    steps:
      - name: Get branch name
        id: branch-name
        uses: tj-actions/branch-names@v7.0.7

  changed-files:
    name: Get changed files
    runs-on: ubuntu-latest
    outputs:
      added-posts: ${{ steps.changed-blog-posts.outputs.added_files }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get changed blog posts
        id: changed-blog-posts
        uses: tj-actions/changed-files@v42
        with:
          files: 'apps/dialtone-documentation/docs/about/whats-new/posts/*.md'
          json: true
          escape_json: false
      - name: List all changed files
        run: echo '${{ steps.changed-blog-posts.outputs.all_changed_files }}'

  extract-markdown-content:
    name: Extract Markdown content
    runs-on: ubuntu-latest
    needs: [get-branch-name, changed-files]
    strategy:
      matrix:
        files: ${{ fromJSON(needs.changed-files.outputs.added-posts) }}
    outputs:
      content: ${{ steps.extract-content.outputs.content }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read markdown file
        id: read-file
        uses: juliangruber/read-file-action@v1
        with:
          path: ${{ matrix.files }}

      - name: Echo file content
        run: echo "${{ steps.read-file.outputs.content }}"

      - name: Find & Replace
        id: remove-frontmatter
        uses: ashley-taylor/regex-property-action@v1.3
        with:
          value: ${{ steps.read-file.outputs.content }}
          regex: /^---$.*^---$/
          flags: "ms"
          replacement: ""

      - name: Print Result
        run: echo "${{ steps.remove-frontmatter.outputs.value }}"

#  send-email:
#    name: Send email
#    runs-on: ubuntu-latest
#    needs: [changed-files]
#    strategy:
#      matrix:
#        files: ${{ fromJSON(needs.changed-files.outputs.added-posts) }}
#    env:
#      FROM_MAIL: julio.ortega@dialpad.com
#      TO_MAIL: julio.ortega@dialpad.com
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#        with:
#          fetch-depth: 0
#
#      - name: Send email
#        uses: dawidd6/action-send-mail@v3
#        with:
#          server_address: smtp.gmail.com
#          server_port: 465
#          secure: true
#          username: ${{ env.FROM_MAIL }}
#          password: ${{ secrets.MAIL_PASSWORD }}
#          subject: Dialtone updates
#          to: ${{ env.TO_MAIL }}
#          from: ${{ env.FROM_MAIL }}
#          html_body: file://${{ matrix.files }}
#          bcc: ${{ env.FROM_MAIL }}
#          reply_to: ${{ env.FROM_MAIL }}
#          convert_markdown: false
#          # Optional nodemailer log: true/false
#          nodemailerlog: true
#          # Optional nodemailer debug: true/false
#          # if true log nodemailer will also be set true
#          nodemailerdebug: true
