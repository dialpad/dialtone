name: Send communications
on:
  workflow_dispatch:
    inputs:
      post_file_name:
        description: 'The post file name'
        required: true
  pull_request:
    paths:
      - 'apps/dialtone-documentation/docs/about/whats-new/posts/*.md'
  push:
    branches:
      - production
    paths:
      - 'apps/dialtone-documentation/docs/about/whats-new/posts/*.md'

env:
  HUSKY: 0

jobs:
  changed-files:
    name: Get changed files
    runs-on: ubuntu-latest
    outputs:
      added-posts: ${{ steps.changed-blog-posts.outputs.added_files }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get changed blog posts
        id: changed-blog-posts
        uses: tj-actions/changed-files@v42
        with:
          files: 'apps/dialtone-documentation/docs/about/whats-new/posts/*.md'
          json: true
          escape_json: false
      - name: List all changed files
        run: echo '${{ steps.changed-blog-posts.outputs.all_changed_files }}'

  send-email:
    name: Send email
    runs-on: ubuntu-latest
    needs: [changed-files]
    strategy:
      matrix:
        files: ${{ fromJSON(needs.changed-files.outputs.added-posts) }}
    env:
      FROM_MAIL: julio.ortega@dialpad.com
      TO_MAIL: julio.ortega@dialpad.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get link from file name
        id: get-post-url
        env:
          MARKDOWN_FILE_PATH: ${{ matrix.files }}
        run: |
          PREFIX="https:\/\/dialtone.dialpad.com"
          echo "POST_URL=$(echo $MARKDOWN_FILE_PATH | sed -e "s/apps\/dialtone-documentation\/docs/$PREFIX/" -e 's/md/html/')" >> $GITHUB_OUTPUT

      # This will do the following:
      # - Remove frontmatter.
      # - Remove script setup.
      # - Remove blog post component.
      # - Remove empty lines at the beginning of the file.
      # - Ellipsis the article to the first 5 lines.
      # - Append the URL of the article at the end of the article.
      - name: Process Markdown file
        env:
          MARKDOWN_FILE_PATH: ${{ matrix.files }}
          POST_URL: ${{ steps.get-post-url.outputs.POST_URL }}
        run: |
          sed -i '/^---$/,/^---$/d' $MARKDOWN_FILE_PATH
          sed -i '/^<script setup>$/,/^<\/script>$/d' $MARKDOWN_FILE_PATH
          sed -i '/^<\/*BlogPost.*$/d' $MARKDOWN_FILE_PATH
          sed -i '/./,$!d' $MARKDOWN_FILE_PATH
          sed -i 5q $MARKDOWN_FILE_PATH
          echo -e "... Read the full article [here]($POST_URL)" >> $MARKDOWN_FILE_PATH

      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ env.FROM_MAIL }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: Dialtone updates
          to: ${{ env.TO_MAIL }}
          from: ${{ env.FROM_MAIL }}
          html_body: file://${{ matrix.files }}
          bcc: ${{ env.FROM_MAIL }}
          reply_to: ${{ env.FROM_MAIL }}
          convert_markdown: true
          # Optional nodemailer log: true/false
          nodemailerlog: true
          # Optional nodemailer debug: true/false
          # if true log nodemailer will also be set true
          nodemailerdebug: true
